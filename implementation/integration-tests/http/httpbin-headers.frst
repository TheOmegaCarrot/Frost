def host_env = getenv('HTTPBIN_HOST')
def host = if is_null(host_env): '127.0.0.1' else: host_env

def port_env = getenv('HTTPBIN_PORT')
def port_str = if is_null(port_env): '8080' else: port_env

def port = to_int(port_str)

def resp = http.request({
  uri: {
    host: host,
    tls: false,
    port: port,
    path: '/get'
  },
  method: 'GET',
  headers: {
    ['x-foo']: 'bar',
    ['x-multi']: 'hello',
    accept: 'application/json'
  }
}).get()

assert(resp.ok, 'http request ok')
assert(resp.response.code == 200, 'status code')

def json = parse_json(resp.response.body)

def headers_lower = map json.headers with fn (k, v) -> { { [to_lower(k)]: v } }

assert(headers_lower['x-foo'] == 'bar', 'x-foo header')
assert(headers_lower['x-multi'] == 'hello', 'x-multi header')
