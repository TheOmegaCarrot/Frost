def host_env = getenv('HTTPBIN_HOST')
def host = if is_null(host_env): '127.0.0.1' else: host_env

def port_env = getenv('HTTPBIN_PORT')
def port_str = if is_null(port_env): '8080' else: port_env

def port = to_int(port_str)

def resp = http.request({
  endpoint: {
    host: host,
    tls: false,
    port: port,
    path: '/post'
  },
  method: 'POST',
  headers: { ['content-type']: 'text/plain' },
  body: 'hello world'
}).get()

assert(resp.ok, 'http request ok')
assert(resp.response.code == 200, 'status code')

def json = parse_json(resp.response.body)
assert(json.data == 'hello world', 'body matches')

def expected_url = 'http://' + host + ':' + to_string(port) + '/post'
assert(json.url == expected_url, 'url matches')
