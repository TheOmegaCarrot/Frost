def port_env = getenv('HTTPBIN_PORT')
def plain_port_str = if is_null(port_env): '8080' else: port_env
def plain_port = to_int(plain_port_str)

def dns_failure = http.request({
  endpoint: {
    host: 'definitely-does-not-exist.invalid',
    tls: false,
    port: 80,
    path: '/'
  },
  method: 'GET',
  timeout_ms: 2000
}).get()

assert(not dns_failure.ok, 'dns failure should fail')
assert(dns_failure.error.category == 'DNS lookup', 'dns category')
assert(dns_failure.error.phase == 'DNS', 'dns phase')

def connect_failure = http.request({
  endpoint: {
    host: '127.0.0.1',
    tls: false,
    port: 6553,
    path: '/'
  },
  method: 'GET',
  timeout_ms: 2000
}).get()

assert(not connect_failure.ok, 'connect failure should fail')
assert(connect_failure.error.category == 'connect', 'connect category')
assert(connect_failure.error.phase == 'connect', 'connect phase')

def tls_failure = http.request({
  endpoint: {
    host: '127.0.0.1',
    tls: true,
    port: plain_port,
    path: '/get'
  },
  method: 'GET',
  timeout_ms: 2000
}).get()

assert(not tls_failure.ok, 'tls failure should fail')
assert(tls_failure.error.category == 'TLS' or tls_failure.error.category == 'timeout',
       'tls category')
assert(tls_failure.error.phase == 'SSL', 'tls phase')
